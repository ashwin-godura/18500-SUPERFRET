<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <title>Playing File</title>
</head>
<body>

    <h1>You are playing {{file.name}}</h1>


    <form id="form" onsubmit="submitForm();">
        {% csrf_token %}
        <label for="speed">Speed:</label>
        <input type="range" id="speed" name="speed" min="1" max="10" step="1" value="5">
    
        <label for="options">Select an option:</label>
        <select id="options" name="options">
          <option value="option1">Option 1</option>
          <option value="option2">Option 2</option>
          <option value="option3">Option 3</option>
        </select>
    
        <label>Mode:</label>
        <label>
          <input type="radio" name="mode" value="training" checked> Training
        </label>
        <label>
          <input type="radio" name="mode" value="performance"> Performance
        </label>
    
        <button type="submit">Submit</button>
      </form>

    <button id="close-button" onclick=stopFile()>Stop</button>
    <button id="pause-button" onclick=pauseFile()>pause</button>
    <button id="restart-button" onclick=restartFile()>restartBlock</button>
    <button id="delete-button" onclick=deleteBlock()>deleteBlock</button>
    <button id="listen-button" onclick="toggleListening()">Not Listening</button>
    <!-- <button id="deleteButton">delete Block</button> -->
    <canvas id="myCanvas" width="1200" height="500"></canvas>

















    <script src="https://cdn.jsdelivr.net/npm/tone@14"></script>
    <script>
        let blockCount = 0;
        const String1Position = 363;
        const Fret1Position = 80;
        const StringGap = 36;
        const FretGap = 86;
        const interval = 10;
        const startPosition = 10;
        const playSpeed = .5
        const update_speed = 1
        // Initialize Tone.js for sound making
        const synth = new Tone.Synth({
			oscillator: {
				type: "amtriangle",
				harmonicity: 0.5,
				modulationType: "sine"
			},
			envelope: {
				attackCurve: "exponential",
				attack: 0.05,
				decay: 0.2,
				sustain: 0.2,
				release: 1.5,
			},
			portamento: 0.05
		}).toDestination();
        const timeDelay =  (String1Position - startPosition) * interval / 1000 // how long it takes from spawning to actually playing, 
                                                              // idea is that block starts at start positions, moves once every interval milliseconds, 
                                                              // until it reaches string1position, so it will take ((string1position - startposition) * interval) / 1000

        const pixels_per_second = update_speed / (interval / 1000)

        var rectangles = [];
        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        var pause = false;
        var listening = false


        function toggleListening() {
            Tone.start()
            listening = !listening;
            var listenButtonText = ""
            if (listening) {
                listenButtonText = "Listening Now"
            } else {
                listenButtonText = "Not Listening"
            }
            document.getElementById('listen-button').innerText = listenButtonText
        }

        // document.getElementById('deleteButton').addEventListener('click', function () {

        //     deleteBlock()
        // });
        function stopFile() {
            window.location.href = '/stopfile'
            return false
        }

        function pauseFile() {
            window.location.href = '/pausefile'
            return false
        }

        function restartFile() {
            window.location.href = '/restartfile'
            return false
        }

        function spawnBlock(fret, stringNumber, note_Value, time_played) {
            switch (stringNumber) {
                case 1: 
                    color = 'red';
                    break;
                case 2:
                    color = 'blue';
                    break;
                case 3:
                    color = 'green';
                    break;
                default:
                    color = 'yellow';
                    break;
            }
            targetPosition = String1Position - (StringGap * stringNumber) 
            xCoordinate = Fret1Position + FretGap * fret
            yCoordinate = startPosition - time_played * pixels_per_second - (StringGap * stringNumber) 

            rect = {
                x: xCoordinate,
                y: yCoordinate,
                targetPosition: targetPosition,
                color: color,
                noteValue: note_Value
            }
            rectangles.push(rect);

            console.log("spawned block with time=",time_played," at ycoord=" + yCoordinate)

            blockCount++;
        }

        function deleteBlock() {
            // Remove the completed rectangle
            if (rectangles.length == 0) {
                return
            }
            var rect = rectangles[0]
            rectangles.splice(0, 1);
            playMidiSound(rect.noteValue)
            pause = false
            // i--; // Adjust the index for the next iteration
        }

        function playNotes(notes) {

            for (var i = 0; i < notes.length; i++) {
                note = notes[i]
                spawnBlock(note.fret, note.string, note.note_value, note.start_time / playSpeed);
            }
            setInterval(animate, interval)
        }

        function animate() {

            // draw all the blocks
            if (pause == true) return
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const image = new Image();
            
            // image from https://bassplayercenter.com/learn-notes-on-the-bass-guitar/
            image.src = 'https://bassplayercenter.com/wp-content/uploads/2019/10/All-notes-on-bass-horiz.png';
            ctx.drawImage(image, 0, 200);

            // Loop through all rectangles
            for (var i = 0; i < rectangles.length; i++) {
                var rect = rectangles[i];

                ctx.strokeStyle = rect.color;
                ctx.fillStyle = rect.color;
                ctx.lineWidth = 3;

                if (rect.y > 0) {
                    ctx.strokeRect(rect.x, rect.targetPosition, 30, 30);
                }
                ctx.fillRect(rect.x, rect.y, 30, 30);

                if (rect.y >= rect.targetPosition) {
                    pause = true;
                    // deleteBlock()
                }
                else {
                    rect.y += update_speed; // Update the position
                }
            }
        }


        // Function to play a MIDI note
        function playMidiSound(note) {
            if (listening == false) return
            var frequency = midiNoteToFrequency(note)
            Tone.start()
            synth.triggerAttackRelease(frequency, "8n");
        }

        function midiNoteToFrequency(note) {
            var ratio = (note - 40) / 12
            return 82.4 * Math.pow(2, ratio);
        }

        function submitForm() {
            var speed = $('#speed').val();
            var options = $('#options').val();
            var mode = $('input[name="mode"]:checked').val();
            var csrftoken = getCookie('csrftoken');
            console.log(csrftoken)

            // AJAX request to send data to the server
            $.ajax({
                url: '/getActiveFile',  // Replace with the actual URL endpoint
                method: 'POST',
                headers: {
                'X-CSRFToken': csrftoken
                },
                data: {
                    'speed': speed,
                    'options': options,
                    'mode': mode
                },
                success: function(response) {
                    // Handle the server response
                    playNotes(response.notes);
                    console.log(response);
                },
                error: function(error) {
                    // Handle errors
                    console.error(error);
                }
            });
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Check if the cookie name matches the expected format
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // Call the function when the page loads
        // window.onload = fetchMidi;
    </script>

</body>
</html>
